<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>1:1 채팅 WebSocket(STOMP) 테스트</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 820px; margin: 24px auto; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; margin-bottom: 14px; }
    legend { font-weight: 700; }
    label { display: inline-block; width: 140px; }
    input { width: calc(100% - 160px); padding: 6px 8px; margin: 4px 0; }
    button { margin: 6px 6px 0 0; padding: 8px 12px; }
    #log { border: 1px solid #ddd; height: 240px; overflow: auto; padding: 8px; border-radius: 8px; background: #fafafa; }
    .row { display: flex; gap: 8px; }
    .row > input { flex: 1; }
    .pill { display:inline-block; padding:2px 8px; border-radius:10px; background:#eee; font-size:12px; margin-left:6px;}
  </style>
</head>
<body>
<h1>1:1 채팅 WebSocket(STOMP) 테스트 <span id="state" class="pill">DISCONNECTED</span></h1>

<fieldset>
  <legend>연결 설정</legend>
  <div class="row">
    <label>엔드포인트</label>
    <input id="endpoint" value="http://localhost:8080/api/websocket/chat" />
  </div>
  <div class="row">
    <label>JWT 토큰</label>
    <input id="token" placeholder="Bearer 없이 순수 액세스 토큰 값" />
  </div>
  <div class="row">
    <label>Room ID</label>
    <input id="roomId" type="number" placeholder="예: 10" />
  </div>
  <button onclick="connect()">Connect</button>
  <button onclick="disconnect()">Disconnect</button>
  <button onclick="subscribeRoom()">Subscribe(개인큐)</button>
  <button onclick="markRead()">읽음 처리</button>
</fieldset>

<fieldset>
  <legend>메시지 전송</legend>
  <div class="row">
    <label>내용</label>
    <input id="message" placeholder="보낼 메시지 내용" />
  </div>
  <button onclick="sendMessage()">Send</button>
</fieldset>

<fieldset>
  <legend>로그</legend>
  <div id="log"></div>
</fieldset>

<script>
  let stomp = null;
  let sock = null;

  const $ = (id) => document.getElementById(id);
  const log = (msg, obj) => {
    const box = $('log');
    const time = new Date().toLocaleTimeString();
    box.innerText += `[${time}] ${msg}\n`;
    if (obj) box.innerText += JSON.stringify(obj, null, 2) + '\n';
    box.scrollTop = box.scrollHeight;
    console.log(msg, obj ?? '');
  };
  const setState = (s) => $('state').textContent = s;

  function connect() {
    const endpoint = $('endpoint').value.trim();
    const token = $('token').value.trim();
    if (!endpoint) return alert('엔드포인트를 입력하세요');
    if (!token)    return alert('JWT 토큰을 입력하세요');

    // 쿼리스트링로 액세스 토큰 전달
    const url = endpoint + '?access_token=' + encodeURIComponent(token);

    sock = new SockJS(url);
    stomp = Stomp.over(sock);
    // 필요 시 콘솔 스팸 줄이기
    // stomp.debug = null;

    stomp.connect(
        { Authorization: 'Bearer ' + token },
        (frame) => {
          setState('CONNECTED');
          log('CONNECTED', frame);
        },
        (err) => {
          setState('ERROR');
          log('CONNECT ERROR', err);
        }
    );
  }

  function disconnect() {
    try {
      if (stomp && stomp.connected) stomp.disconnect(() => { setState('DISCONNECTED'); log('DISCONNECTED'); });
      if (sock) sock.close();
    } catch (e) {
      log('DISCONNECT ERROR', e);
    } finally {
      stomp = null; sock = null;
    }
  }

  function subscribeRoom() {
    if (!stomp || !stomp.connected) return alert('먼저 Connect 하세요');
    const roomId = $('roomId').value.trim();
    if (!roomId) return alert('Room ID를 입력하세요');

    const dest = `/user/queue/rooms.${roomId}`;
    stomp.subscribe(dest, (msg) => {
      try {
        const body = JSON.parse(msg.body);
        log(`RECV ${dest}`, body);
      } catch (e) {
        log(`RECV(raw) ${dest}`, msg.body);
      }
    });
    log(`SUBSCRIBE ${dest}`);
  }

  function markRead() {
    if (!stomp || !stomp.connected) return alert('먼저 Connect 하세요');
    const roomId = $('roomId').value.trim();
    if (!roomId) return alert('Room ID를 입력하세요');

    const dest = `/app/chat/rooms/${roomId}/read`;
    stomp.send(dest, {}, {});
    log(`SEND(read) ${dest}`);
  }

  function sendMessage() {
    if (!stomp || !stomp.connected) return alert('먼저 Connect 하세요');
    const roomId = $('roomId').value.trim();
    const text = $('message').value;
    if (!roomId) return alert('Room ID를 입력하세요');
    if (!text)   return alert('메시지를 입력하세요');

    const dest = `/app/chat/rooms/${roomId}/messages`;
    const payload = { content: text };
    stomp.send(dest, {}, JSON.stringify(payload));
    log(`SEND(msg) ${dest}`, payload);
  }
</script>
</body>
</html>
